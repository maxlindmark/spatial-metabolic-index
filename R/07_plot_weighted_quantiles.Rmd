---
title: "Calculate metabolic index velocities for each species and plot biomass-weighted environmental quantiles"
author: "Max Lindmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro
Main analysis: This scripts reads prediction grids with predicted biomass densities ("02_fit_sdm_pred") and calculates metabolic indexes by species and life stage, as well as velocities of the metabolic index, temperature and oxygen.

```{r load libraries, message=FALSE, warning=TRUE}
# Load libraries, install if needed
library(tidyverse)
library(tidylog)
library(RCurl)
library(devtools)
library(sdmTMB)
library(rMR)
library(patchwork)
library(raster)
library(VoCC)
library(RColorBrewer)
library(viridis)

# Source code for plots
source_url("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/R/functions/map-plot.R")

theme_set(theme_plot())

pal <- brewer.pal(name = "Dark2", n = 8)
```

```{r}
# Read predictions grids
# d <- read_csv("output/grid_pred_biomass_02.csv") %>% 
#   separate(model, c("species", "life_stage"), sep = "_", remove = FALSE) %>% 
#   rename(group = model) %>% 
#   filter(quarter == 4) # For now we'll do q4

# Spatial trend model instead
d <- read_csv("output/spatial_trend_biom_pred.csv") %>% 
  separate(group, c("species", "life_stage"), sep = "_", remove = FALSE) %>% 
  filter(quarter == 4) # For now we'll do q4

# Read metabolic parameter estimates and left_join
mi_pars <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/data/clean/mi_params.csv") %>% 
  dplyr::select(-...1, -temp)

# TODO: for now we'll use plaice parameters for flounder, see "00_estimate_mi_params.Rmd"
mi_pars2 <- mi_pars
mi_pars2[4, c(4:5)] <- mi_pars2[1, c(4:5)]

d <- left_join(d, mi_pars2, by = "species")

# Read size csv to calculate the metabolic index
sizes <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/data/clean/sizes.csv") %>% 
  mutate(group = paste(species, name, sep = "_")) %>% 
  dplyr::select(group, B)

d <- left_join(d, sizes, by = "group")
```

## Calculate the metabolic index

```{r calculate metabolic index}
# Before we can calculate the pressure based metabolic index, we'll need to convert oxygen from ml/L mg/L and partial pressure
# Some conversions
# oxygen: https://www.ices.dk/data/tools/Pages/Unit-conversions.aspx
# pressure: https://bluerobotics.com/learn/pressure-depth-calculator/
# First calculate pressure in pascal: p_tot = (r*g*h) + p_atm, then to kgPa and finally atm
rho = 1030 # density of water
p_atm = 1.01325 # atmospheric pressure
g = 9.807 # gravity of earth

# Convert to partial pressure oxygen from ml/L
d$po2 <- DO.unit.convert(d$oxy*(1/0.7), # d$oxy is in unit ml/L so we first need to convert to mg/L
                         DO.units.in = "mg/L", 
                         DO.units.out = "PP", 
                         bar.press = ((rho*g*d$depth + p_atm)*10^-5)*0.986923, 
                         bar.units.in = "atm",
                         bar.units.out = "kpa",
                         temp.C = d$temp,
                         salinity = 10, # TODO: d$sal, # let's fix salinity for easier comparison. It has a minor effect in this range
                         salinity.units = "pp.thou")

# Oxygen is ml/L, We want micro mol/L. 1 ml/l = 10^3/22.391 = 44.661 micro mol/l
d$oxy_si <- (d$oxy * (10^3)) / 22.391

# Calculate metabolic indices for a given mass and the temperature and oxygen in data
# Line 123 in https://github.com/fate-spatialindicators/SDM_O2/blob/master/code/mi_functions.R
kb <- 0.000086173324 # Boltzmann's constant
t_ref <- 15 # arbitrary reference temperature

# Calculate the metabolic index for concentration 
d <- d %>%
  mutate(inv_temp = (1/(temp + 273.15) - 1/(t_ref + 273.15)),
         phi_c = A0_o2*(B^n_o2)*oxy_si * exp((E_o2/kb)*inv_temp))
```

Calculate weighted quantiles of oxygen, temperature and phi by species and life stage

```{r}
wq <- d %>% 
  pivot_longer(c(phi_c, oxy, temp), names_to = "env_var", values_to = "value") %>% 
  group_by(year, group) %>%
  mutate(lwr = quantile(est, probs = 0.01),
         upr = quantile(est, probs = 0.99)) %>% # trim quantiles
  ungroup() %>%
  filter(est > lwr & est < upr) %>%
  group_by(env_var, year, group) %>%
  summarise("Environment" = median(value),
            "10%" = hutils::weighted_quantile(v = value, w = exp(est), p = c(0.1)),
            "Weighted median" = hutils::weighted_quantile(v = value, w = exp(est), p = c(0.5)),
            "95%" = hutils::weighted_quantile(v = value, w = exp(est), p = c(0.95))) %>%
  pivot_longer(c(Environment, `Weighted median`), names_to = "var", values_to = "Median") %>%
  mutate(`10%` = ifelse(var == "Environment", NA, `10%`),
         `95%` = ifelse(var == "Environment", NA, `95%`)) %>%
  ungroup() %>%
  separate(group, c("species", "life_stage"), sep = "_", remove = FALSE) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage))
```

```{r plot weighted means}
# Group by quantile instead and use colors or linetypes
wq %>% 
  filter(env_var == "temp") %>% 
  pivot_longer(c(`10%`, Median, `95%`)) %>% 
  filter(name %in% c("Median")) %>% 
  ggplot(aes(year, value, linetype = var, color = var)) + 
  geom_line() + 
  scale_linetype_manual(values = c(2, 1)) +
  scale_color_manual(values = rev(pal)) +
  facet_grid(life_stage ~ species) + 
  labs(y = "Temperature (°C)", x = "Year", linetype = "", color = "") + 
  theme_plot(base_size = 14) +
  theme(aspect.ratio = 1.2,
        legend.position = c(0.1, 0.58),
        legend.spacing.y = unit(0, 'cm'),
        legend.background = element_rect(fill = NA),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 7))

ggsave("figures/wm_temp.pdf", width = 17, height = 17, units = "cm", device = cairo_pdf)


wq %>% 
  filter(env_var == "temp") %>% 
  pivot_longer(c(`10%`, Median, `95%`)) %>% 
  filter(name %in% c("Median")) %>% 
  mutate(id2 = paste(species, life_stage)) %>% 
  ggplot(aes(year, value, linetype = var, alpha = var, color = id2)) + 
  geom_line() + 
  # geom_point() + 
  # stat_smooth(method = "lm") +
  scale_linetype_manual(values = c(2, 1)) +
  scale_color_manual(values = rev(pal)) +
  scale_alpha_manual(values = c(1, 0.6)) +
  #facet_grid(life_stage ~ species) + 
  labs(y = "Temperature (°C)", x = "Year", linetype = "", color = "") + 
  theme_plot(base_size = 14) +
  guides(alpha = "none") +
  theme(aspect.ratio = 3/4,
        legend.position = "right",
        legend.direction = "vertical",
        legend.spacing.y = unit(0, 'cm'),
        legend.background = element_rect(fill = NA),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 7))

ggsave("figures/wm_temp.pdf", width = 17, height = 17, units = "cm", device = cairo_pdf)

# Metabolic index
wq %>% 
  filter(env_var == "phi_c") %>% 
  pivot_longer(c(`10%`, Median, `95%`)) %>% 
  filter(name %in% c("Median")) %>% 
  ggplot(aes(year, value, linetype = var, color = species)) + 
  geom_line() + 
  scale_linetype_manual(values = c(2, 1)) +
  scale_color_manual(values = rev(pal)) +
  facet_wrap(~life_stage) + 
  labs(y = "Metabolic index (\u03C6)", x = "Year", linetype = "", color = "") + 
  theme_plot(base_size = 14) +
  theme(aspect.ratio = 1,
        legend.position = c(0.1, 0.82),
        legend.spacing.y = unit(0.2, 'cm'),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 7))

ggsave("figures/wm_mi.pdf", width = 17, height = 17, units = "cm", device = cairo_pdf)
```

## Plot slopes of weighted average quantiles over time

```{r mi slopes over time}
# Are there any "significant" trends over time?
yr_slopes <- wq %>%
  pivot_longer(c(`10%`, Median)) %>% 
  filter(name == "Median") %>% 
  mutate(env_var = ifelse(env_var == "phi_c", "phi", env_var)) %>% 
  filter(!var == "Environment") %>% 
  mutate(id = paste(name, group, env_var, sep = "_")) %>% 
  split(.$id) %>%
  purrr::map(~lm(value ~ year, data = .x)) %>%
  purrr::map_df(broom::tidy, .id = 'id') %>%
  filter(term == "year") %>% 
  #separate(id_lw, c("year", "species"), sep = "_") %>%
  mutate(lwr = estimate - 1.96*std.error,
         upr = estimate + 1.96*std.error) %>% 
  separate(id, c("quantile", "species", "life_stage", "var"), sep = "_", remove = FALSE) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage)) %>% 
  mutate(var = ifelse(var == "oxy", "Oxygen", var),
         var = ifelse(var == "temp", "Temperature", var),
         var = ifelse(var == "phi", "Phi", var))

# Environment...
# yr_slopes2 <- wq %>%
#   pivot_longer(c(`10%`, Median)) %>% 
#   filter(name == "Median") %>% 
#   mutate(env_var = ifelse(env_var == "phi_c", "phi", env_var)) %>% 
#   filter(var == "Environment") %>% 
#   mutate(id = paste(name, group, env_var, sep = "_")) %>% 
#   split(.$id) %>%
#   purrr::map(~lm(value ~ year, data = .x)) %>%
#   purrr::map_df(broom::tidy, .id = 'id') %>%
#   filter(term == "year") %>% 
#   #separate(id_lw, c("year", "species"), sep = "_") %>%
#   mutate(lwr = estimate - 1.96*std.error,
#          upr = estimate + 1.96*std.error) %>% 
#   separate(id, c("quantile", "species", "life_stage", "var"), sep = "_", remove = FALSE) %>% 
#   mutate(species = str_to_title(species),
#          life_stage = str_to_title(life_stage)) %>% 
#   mutate(var = ifelse(var == "oxy", "Oxygen", var),
#          var = ifelse(var == "temp", "Temperature", var),
#          var = ifelse(var == "phi", "Phi", var))
# 
# yr_slopes3 <- bind_rows(yr_slopes,
#                         yr_slopes2 %>% mutate(species = "Environment"))

# Plot year slopes!
# ggplot(yr_slopes, aes(x = factor(var, level = c('Oxygen', 'Temperature', 'Phi')),
#                       estimate, ymin = lwr, ymax = upr, color = species, shape = var)) + 
#   geom_hline(yintercept = 0, linetype = 2, color = "grey60") +
#   geom_point(position = position_dodge(width = 0.6)) + 
#   geom_errorbar(width = 0, position = position_dodge(width = 0.6)) + 
#   scale_color_manual(values = rev(pal)) +
#   facet_wrap(~life_stage) +
#   labs(x = "", y = "Year slope", shape = "Quantile", color = "Species") +
#   guides(color = guide_legend(order = 1)) + 
#   scale_x_discrete(labels = c('Phi' = expression(phi))) +
#   theme(aspect.ratio = 1.5,
#         legend.position = c(0.07, 0.88),
#         legend.background = element_rect(fill = NA),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 7))
#   
# ggsave("figures/weighted_yr_slopes_vars.pdf", width = 17, height = 17, units = "cm")
```
