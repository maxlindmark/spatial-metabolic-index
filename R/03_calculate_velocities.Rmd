---
title: "Calculate metabolic index velocities for each species"
author: "Max Lindmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro
Main analysis: This scripts reads prediction grids with predicted biomass densities ("02_fit_sdm_pred") and calculates metabolic indexes by species and life stage, as well as velocities of the metabolic index, temperature and oxygen.

```{r load libraries, message=FALSE, warning=TRUE}
# Load libraries, install if needed
library(tidyverse)
library(tidylog)
library(RCurl)
library(devtools)
library(sdmTMB)
library(rMR)
library(patchwork)
library(raster)
library(VoCC)
library(RColorBrewer)
library(viridis)

# Source code for plots
source_url("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/R/functions/map-plot.R")

theme_set(theme_plot())

pal <- brewer.pal(name = "Dark2", n = 8)
```

```{r}
# Read predictions grids
d <- read_csv("output/grid_pred_biomass_02.csv") %>%
  separate(model, c("species", "life_stage"), sep = "_", remove = FALSE) %>%
  rename(group = model)

# test plot!
g <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/warm-life-history/master/data/for_fitting/growth_scaling_dat.csv")

# d_test <- d %>% filter(year == 2000 & species == "cod" & life_stage == "adult")
# 
# plot_map + 
#   geom_raster(data = d_test, aes(X*1000, Y*1000, fill = exp(est))) + 
#   facet_wrap(~quarter)

# d <- read_csv("output/spatial_trend_biom_pred.csv") %>% 
#   separate(group, c("species", "life_stage"), sep = "_", remove = FALSE)

# d_test <- d %>% filter(group == "cod_juvenile")
# d2_test <- d2 %>% filter(group == "cod_juvenile")
# plot(exp(d_test$est), exp(d2_test$est)); abline()

# Read metabolic parameter estimates and left_join
mi_pars <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/data/clean/mi_params.csv") %>% 
  dplyr::select(-...1, -temp)

# TODO: for now we'll use plaice parameters for flounder, see "00_estimate_mi_params.Rmd"
mi_pars2 <- mi_pars
mi_pars2[4, c(4:5)] <- mi_pars2[1, c(4:5)]

d <- left_join(d, mi_pars2, by = "species")

# Read size csv to calculate the metabolic index
sizes <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/data/clean/sizes.csv") %>% 
  mutate(group = paste(species, name, sep = "_")) %>% 
  dplyr::select(group, B)

d <- left_join(d, sizes, by = "group")
```

## Calculate the metabolic index

```{r calculate metabolic index}
# Before we can calculate the pressure based metabolic index, we'll need to convert oxygen from ml/L mg/L and partial pressure
# Some conversions
# oxygen: https://www.ices.dk/data/tools/Pages/Unit-conversions.aspx
# pressure: https://bluerobotics.com/learn/pressure-depth-calculator/
# First calculate pressure in pascal: p_tot = (r*g*h) + p_atm, then to kgPa and finally atm
rho = 1030 # density of water
p_atm = 1.01325 # atmospheric pressure
g = 9.807 # gravity of earth

# Convert to partial pressure oxygen from ml/L
d$po2 <- DO.unit.convert(d$oxy*(1/0.7), # d$oxy is in unit ml/L so we first need to convert to mg/L
                         DO.units.in = "mg/L", 
                         DO.units.out = "PP", 
                         bar.press = ((rho*g*d$depth + p_atm)*10^-5)*0.986923, 
                         bar.units.in = "atm",
                         bar.units.out = "kpa",
                         temp.C = d$temp,
                         salinity = 10, # TODO: d$sal, # let's fix salinity for easier comparison. It has a minor effect in this range
                         salinity.units = "pp.thou")

# Oxygen is ml/L, We want micro mol/L. 1 ml/l = 10^3/22.391 = 44.661 micro mol/l
d$oxy_si <- (d$oxy * (10^3)) / 22.391

# Calculate metabolic indices for a given mass and the temperature and oxygen in data
# Line 123 in https://github.com/fate-spatialindicators/SDM_O2/blob/master/code/mi_functions.R
kb <- 0.000086173324 # Boltzmann's constant
t_ref <- 15 # arbitrary reference temperature

# Calculate the metabolic index for concentration 
d <- d %>%
  mutate(inv_temp = (1/(temp + 273.15) - 1/(t_ref + 273.15)),
         phi_c = A0_o2*(B^n_o2)*oxy_si * exp((E_o2/kb)*inv_temp))
```

## Calculate phi velocities!

```{r mi velocities}
# Loop through year, species and life stage, make a data frame of phi-velocities
d2 <- d %>%
  rename(phi = phi_c) %>% 
  dplyr::select(year, phi, group, quarter, X, Y) %>% 
  mutate(group2 = paste(group, quarter, sep = "_"))

velo_list <- list()

for(i in unique(d2$group2)) {
  
  d_sub <- filter(d2, group2 == i)
  
  # Convert pred grid to raster stack
  # https://gist.github.com/statnmap/a3eb564d06dee47f2d83eceac4212881
  d_sub_rs <- d_sub %>% 
    group_split(year) %>% 
    map(~rasterFromXYZ(.x[,c("X", "Y", "phi")])) %>% 
    stack()

  #plot(d_sub_rs)
  
  # Temporal trend
  vt2 <- tempTrend(d_sub_rs, th = 10) # th = Integer minimum number of observations in the series needed to calculate the trend at each cell.
  
  # Spatial gradient
  vg2 <- spatGrad(d_sub_rs, projected = TRUE)
  
  # Climate velocity
  gv2 <- gVoCC(vt2, vg2)
  
  # (so that we can use ggplot)
  points <- rasterToPoints(gv2)
  
  # Make the points a dataframe for ggplot
  df <- data.frame(points) %>%
    rename(X = x, Y = y) %>% 
    mutate(group = i) %>% 
    separate(group, c("species", "life_stage", "quarter"),
             sep = "_", remove = FALSE) %>% 
    mutate(species = str_to_title(species),
           life_stage = str_to_title(life_stage))
  
  # Save!
  velo_list[[i]] <- df
  
}

phi_velo_df <- dplyr::bind_rows(velo_list)
```

## Calculate temperature velocities!

```{r temperature velocities}
# Loop through year, species and life stage, make a data frame of phi-velocities
d2 <- d %>%
  dplyr::select(year, temp, group, quarter, X, Y) %>% 
  mutate(group2 = paste(group, quarter, sep = "_"))

velo_list <- list()

for(i in unique(d2$group2)) {
  
  d_sub <- filter(d2, group2 == i)
  
  # Convert pred grid to raster stack
  # https://gist.github.com/statnmap/a3eb564d06dee47f2d83eceac4212881
  d_sub_rs <- d_sub %>% 
    group_split(year) %>% 
    map(~rasterFromXYZ(.x[,c("X", "Y", "temp")])) %>% 
    stack()

  #plot(d_sub_rs)
  
  # Temporal trend
  vt2 <- tempTrend(d_sub_rs, th = 10) # th = Integer minimum number of observations in the series needed to calculate the trend at each cell.
  
  # Spatial gradient
  vg2 <- spatGrad(d_sub_rs, projected = TRUE)
  
  # Climate velocity
  gv2 <- gVoCC(vt2, vg2)
  
  # (so that we can use ggplot)
  points <- rasterToPoints(gv2)
  
  # Make the points a dataframe for ggplot
  df <- data.frame(points) %>%
    rename(X = x, Y = y) %>% 
    mutate(group = i) %>% 
    separate(group, c("species", "life_stage", "quarter"),
             sep = "_", remove = FALSE) %>% 
    mutate(species = str_to_title(species),
           life_stage = str_to_title(life_stage))
  
  # Save!
  velo_list[[i]] <- df
  
}

temp_velo_df <- dplyr::bind_rows(velo_list)
```

## Calculate biotic velocities!

```{r bio velocities}
# Loop through year, quarter, species and life stage, make a data frame of phi-velocities
d2 <- d %>%
  dplyr::select(year, est, group, quarter, X, Y) %>% 
  mutate(group2 = paste(group, quarter, sep = "_")) %>% 
  mutate(exp_est = exp(est))

velo_list <- list()

for(i in unique(d2$group2)) {
  
  d_sub <- filter(d2, group2 == i)
  
  # Convert pred grid to raster stack
  # https://gist.github.com/statnmap/a3eb564d06dee47f2d83eceac4212881
  d_sub_rs <- d_sub %>% 
    group_split(year) %>% 
    map(~rasterFromXYZ(.x[,c("X", "Y", "exp_est")])) %>% 
    stack()

  #plot(d_sub_rs)
  
  # Temporal trend
  vt2 <- tempTrend(d_sub_rs, th = 10) # th = Integer minimum number of observations in the series needed to calculate the trend at each cell.
  
  # Spatial gradient
  vg2 <- spatGrad(d_sub_rs, projected = TRUE)
  
  # Climate velocity
  gv2 <- gVoCC(vt2, vg2)
  
  # (so that we can use ggplot)
  points <- rasterToPoints(gv2)
  
  # Make the points a dataframe for ggplot
  df <- data.frame(points) %>%
    rename(X = x, Y = y) %>% 
    mutate(group = i) %>% 
    separate(group, c("species", "life_stage", "quarter"),
             sep = "_", remove = FALSE) %>% 
    mutate(species = str_to_title(species),
           life_stage = str_to_title(life_stage))
  
  # Save!
  velo_list[[i]] <- df
  
}

bio_velo_df <- dplyr::bind_rows(velo_list)
```

## Merge velocity data data frames, then add values from the prediction data frame (mean phi, mean biomass density)

```{r join dataframes}
# Make velocity data frames a single one and trim by quantiles (NA and Inf also)
bio_velo_df_sub <- bio_velo_df %>%
  mutate(id = paste(X, Y, group, sep = "_")) %>%
  dplyr::select(voccMag, id) %>%
  rename(bio_vel = voccMag)

phi_velo_df_sub <- phi_velo_df %>%
  mutate(id = paste(X, Y, group, sep = "_")) %>%
  dplyr::select(voccMag, id) %>%
  rename(phi_vel = voccMag)

temp_velo_df_sub <- temp_velo_df %>%
  mutate(id = paste(X, Y, group, sep = "_")) %>%
  dplyr::select(voccMag, id) %>%
  rename(temp_vel = voccMag)

velo_df <- left_join(bio_velo_df_sub, phi_velo_df_sub) %>% left_join(temp_velo_df_sub)
head(velo_df)

# Trim the velocities by quantiles
velo_df %>% 
  pivot_longer(c(bio_vel, phi_vel, temp_vel)) %>% 
  ggplot(aes(value)) + geom_histogram() + facet_wrap(~name, ncol = 1)
  
velo_df <- velo_df %>% 
  filter(bio_vel  > quantile(bio_vel, probs = 0.01),
         bio_vel  < quantile(bio_vel, probs = 0.99),
         temp_vel > quantile(temp_vel, probs = 0.01),
         temp_vel < quantile(temp_vel, probs = 0.99),
         phi_vel  > quantile(phi_vel, probs = 0.01),
         phi_vel  < quantile(phi_vel, probs = 0.99))

velo_df %>% 
  pivot_longer(c(bio_vel, phi_vel, temp_vel)) %>% 
  ggplot(aes(value)) + geom_histogram() + facet_wrap(~name, ncol = 1)

# All good. Now trim the prediction grid to use only cells (by species and life stage) that cumulatively encompass 95% of biomass

# Cumulative filter instead
# d_test <- data.frame(y = round(rnorm(10, 10, 2))) %>% 
#   arrange(desc(y)) %>%
#   mutate(cumsum = cumsum(y),
#          sum = sum(y),
#          perc = cumsum / sum)
# 
# d_test
# 
# d_test %>% filter(perc < 0.95)

d_grid_keep <- d %>%
  mutate(group = paste(group, quarter, sep = "_")) %>% 
  group_by(X, Y, group) %>% 
  summarise(grid_mean = mean(exp(est))) %>% 
  ungroup() %>% 
  group_by(group) %>%
  arrange(desc(grid_mean)) %>% 
  mutate(cumsum = cumsum(grid_mean),
         sum = sum(grid_mean),
         perc = cumsum / sum) %>% 
  ungroup() %>% 
  filter(perc < 0.95) %>% 
  mutate(id = paste(X, Y, group, sep = "_"))

# Filter the main dataset to include these grid cells only
pred_grid_trim <- d %>% 
  mutate(group = paste(group, quarter, sep = "_")) %>% 
  mutate(id = paste(X, Y, group, sep = "_")) %>% 
  filter(id %in% unique(d_grid_keep$id))

# Filter id's that are in the velocities data frame...
pred_grid_trim <- pred_grid_trim %>% 
  filter(id %in% unique(velo_df$id))

# ... Now that we have the final set of grid cells by species, summarize grid cell average oxygen, temperature, phi and biomass, then left join that with the velocity dataframe
pred_grid_sum <- pred_grid_trim %>% 
  group_by(id) %>% 
  summarise(mean_log_biomass = mean(est),
            mean_temp = mean(temp),
            mean_oxy = mean(oxy),
            mean_phi = mean(phi_c)) %>% 
  # Center the average across year variables
  mutate(mean_log_biomass_ct = mean_log_biomass - mean(mean_log_biomass),
         mean_temp_ct = mean_temp - mean(mean_temp),
         mean_oxy_ct = mean_oxy - mean(mean_oxy),
         mean_phi_ct = mean_phi - mean(mean_phi)) %>%
  ungroup() %>% 
  dplyr::select(id, mean_log_biomass, mean_temp, mean_oxy, mean_phi,
                mean_log_biomass_ct, mean_temp_ct, mean_oxy_ct, mean_phi_ct)

# Left join velocities into the summarized prediction grid
velo <- left_join(pred_grid_sum, velo_df) %>% 
  separate(id, c("X", "Y", "species", "life_stage", "quarter"), sep = "_", remove = FALSE) %>% 
  mutate(group = paste(species, life_stage, sep = "_"))

# Scale velocity variables
velo <- velo %>% 
  ungroup() %>% 
  drop_na(phi_vel, temp_vel, bio_vel) %>% 
  filter(is.finite(bio_vel)) %>%
  filter(is.finite(phi_vel)) %>%
  filter(is.finite(temp_vel)) %>%
  group_by(group) %>% 
  mutate(phi_vel_mean = mean(phi_vel),
         phi_vel_sd = sd(phi_vel),
         temp_vel_mean = mean(temp_vel),
         temp_vel_sd = sd(temp_vel)) %>% 
  ungroup() %>% 
  mutate(phi_vel_sc = (phi_vel - phi_vel_mean)/phi_vel_sd,
         temp_vel_sc = (temp_vel - temp_vel_mean)/temp_vel_sd) %>% 
  dplyr::select(-phi_vel_mean, -phi_vel_sd, -temp_vel_mean, -temp_vel_sd) %>% 
  mutate(X = as.numeric(X),
         Y = as.numeric(Y))

str(velo)
summary(velo)
names(velo)

q1 <- ggplot(filter(velo, quarter == 1), aes(X, Y, fill = mean_log_biomass)) + 
  geom_raster() + 
  facet_grid(life_stage ~ species) +
  scale_fill_viridis() +
  coord_sf()

q4 <- ggplot(filter(velo, quarter == 4), aes(X, Y, fill = mean_log_biomass)) + 
  geom_raster() + 
  facet_grid(life_stage ~ species) +
  scale_fill_viridis() +
  coord_sf()

q1 / q4
```

```{r}
# Save data
write_csv(velo, "data/clean/velocities.csv")
```
