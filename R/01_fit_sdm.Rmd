---
title: "Fit tweedie models to biomass density and extract AIC"
author: "Max Lindmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro

Fit Tweedie models to biomass density of cod, flounder, plaice and dab (juveniles and adults) between 1993-2020 in the Baltic Sea using sdmMTB fit different oxygen and temperature-related covariates, compare AIC. Select the "best" covariate for further trend and velocity analysis.

## Load packages & source functions

```{r load libraries, message=FALSE, warning=TRUE}
# Load libraries, install if needed
library(tidyverse)
library(readxl)
library(tidylog)
library(RCurl)
library(devtools)
library(sdmTMB)
library(rMR)
library(kableExtra)
library(RColorBrewer)

# Source code for plots
source_url("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/R/functions/map-plot.R")

theme_set(theme_plot())

pal <- brewer.pal(name = "Dark2", n = 8)
```

```{r read data}
# Read data
d <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/data/clean/catch_clean.csv") %>%
  rename(X = x, Y = y) %>% 
  drop_na(depth) %>% 
  mutate(depth_ct = depth - mean(depth),
         depth_sc = depth_ct / sd(depth),
         depth_sq = depth_sc^2,
         year_f = as.factor(year),
         quarter_f = as.factor(quarter)) %>% 
  pivot_longer(c(cod_adult, cod_juvenile, dab_adult, dab_juvenile, flounder_adult,
                 flounder_juvenile, plaice_adult, plaice_juvenile),
               names_to = "group", values_to = "density") %>% 
  separate(group, into = c("species", "life_stage"), remove = FALSE)

# Read metabolic parameter estimates and left_join
mi_pars <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/data/clean/mi_params.csv") %>% 
  dplyr::select(-...1, -temp)

# TODO: for now we'll use plaice parameters for flounder, see "00_estimate_mi_params.Rmd"
mi_pars2 <- mi_pars
mi_pars2[4, c(4:5)] <- mi_pars2[1, c(4:5)]

d <- left_join(d, mi_pars2, by = "species")

# Read size csv to calculate the metabolic index
sizes <- readr::read_csv("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/data/clean/sizes.csv") %>% 
  mutate(group = paste(species, name, sep = "_")) %>% 
  dplyr::select(group, B)

d <- left_join(d, sizes, by = "group")
```

## Calculate the metabolic index

```{r calculate metabolic index}
# Before we can calculate the pressure based metabolic index, we'll need to convert oxygen from ml/L mg/L and partial pressure
# Some conversions
# oxygen: https://www.ices.dk/data/tools/Pages/Unit-conversions.aspx
# pressure: https://bluerobotics.com/learn/pressure-depth-calculator/
# First calculate pressure in pascal: p_tot = (r*g*h) + p_atm, then to kgPa and finally atm
rho = 1030 # density of water
p_atm = 1.01325 # atmospheric pressure
g = 9.807 # gravity of earth

# Convert to partial pressure oxygen from ml/L
d$po2 <- DO.unit.convert(d$oxy*(1/0.7), # d$oxy is in unit ml/L so we first need to convert to mg/L
                         DO.units.in = "mg/L", 
                         DO.units.out = "PP", 
                         bar.press = ((rho*g*d$depth + p_atm)*10^-5)*0.986923, 
                         bar.units.in = "atm",
                         bar.units.out = "kpa",
                         temp.C = d$temp,
                         salinity = 10, # TODO: d$sal, # let's fix salinity for easier comparison. It has a minor effect in this range
                         salinity.units = "pp.thou")

# Oxygen is ml/L, We want micro mol/L. 1 ml/l = 10^3/22.391 = 44.661 micro mol/l
d$oxy_si <- (d$oxy * (10^3)) / 22.391

# Calculate metabolic indices for a given mass and the temperature and oxygen in data
# Line 123 in https://github.com/fate-spatialindicators/SDM_O2/blob/master/code/mi_functions.R
kb <- 0.000086173324 # Boltzmann's constant
t_ref <- 15 # arbitrary reference temperature

# Calculate the metabolic index for pressure and concentration 
d <- d %>%
  mutate(inv_temp = (1/(temp + 273.15) - 1/(t_ref + 273.15)),
         phi = A0_po2*(B^n_po2)*po2 * exp((E_po2/kb)*inv_temp),
         phi_c = A0_o2*(B^n_o2)*oxy_si * exp((E_o2/kb)*inv_temp))
```

## Scale variables

```{r}
d <- d %>% 
  group_by(group) %>% 
  mutate(phi_sc = scale(phi),
         phi_c_sc = scale(phi_c),
         oxy_sc = scale(oxy), 
         temp_sc = scale(temp),
         depth_sc = scale(depth)) %>% 
  ungroup() %>% 
  drop_na(phi, phi_c)
```

```{r}
# Plot mi by species and life stage
d %>% 
  pivot_longer(c(phi, phi_c)) %>% 
  ggplot(aes(value, fill = name, color = name)) + 
  geom_density(trim = TRUE, alpha = 0.3) + 
  scale_color_brewer(palette = "Dark2", name = "") +
  scale_fill_brewer(palette = "Dark2", name = "") +
  geom_vline(xintercept = 0, linetype = 2, color = "grey20") + 
  coord_cartesian(expand = 0) + 
  facet_grid(life_stage ~ species)
```

## Fit models and save AIC

```{r fit models}
#data_list_coef <- list()
data_list_aic <- list()

i <- "plaice_juvenile"#unique(d$group)[1]

#d2 <- d %>% filter(species %in% c("dab", "plaice"))

for(i in unique(d$group)) { 
    
    dd <- d %>%
      filter(group == i) %>%
      droplevels() %>% 
      drop_na(density)
    
    mesh <- make_mesh(dd, c("X", "Y"), n_knots = 200)

    plot(mesh)
    
    m1 <- sdmTMB(
      density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + temp_sc,
      data = dd, mesh = mesh, family = tweedie(link = "log"),
      spatial = "on", time = "year", spatiotemporal = "off",
      control = sdmTMBcontrol(newton_loops = 1))
      
    m2 <- sdmTMB(
      density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + breakpt(oxy_sc),
      data = dd, mesh = mesh, family = tweedie(link = "log"),
      spatial = "on", time = "year", spatiotemporal = "off")
    
    m3 <- sdmTMB(
      density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + breakpt(oxy_sc) + temp_sc,
      data = dd, mesh = mesh, family = tweedie(link = "log"),
      spatial = "on", time = "year", spatiotemporal = "off",
      control = sdmTMBcontrol(newton_loops = 1))
    
    m4 <- sdmTMB(
      density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + oxy_sc*temp_sc,
      data = dd, mesh = mesh, family = tweedie(link = "log"),
      spatial = "on", time = "year", spatiotemporal = "off",
      control = sdmTMBcontrol(newton_loops = 1))

    # m5 <- sdmTMB(
    #   density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + breakpt(phi_sc),
    #   data = dd, mesh = mesh, family = tweedie(link = "log"),
    #   spatial = "on", time = "year", spatiotemporal = "off",
    #   control = sdmTMBcontrol(newton_loops = 1))
     
    # m6 <- sdmTMB(
    #   density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + breakpt(phi_c_sc),
    #   data = dd, mesh = mesh, family = tweedie(link = "log"),
    #   spatial = "on", time = "year", spatiotemporal = "off",
    #   control = sdmTMBcontrol(newton_loops = 1))
  
    m7 <- sdmTMB(
      density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + s(phi_sc),
      data = dd, mesh = mesh, family = tweedie(link = "log"),
      spatial = "on", time = "year", spatiotemporal = "off",
      control = sdmTMBcontrol(newton_loops = 1))

    m8 <- sdmTMB(
      density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + s(phi_c_sc),
      data = dd, mesh = mesh, family = tweedie(link = "log"),
      spatial = "on", time = "year", spatiotemporal = "off",
      control = sdmTMBcontrol(newton_loops = 1))

    sanity(m1)
    sanity(m2)
    sanity(m3)
    sanity(m4)
    # sanity(m5)
    # sanity(m6)
    sanity(m7)
    sanity(m8)
    
    data_list_aic[[i]] <- AIC(m1, m2, m3, m4, 
                              #m5, m6,
                              m7, m8) %>%
      tibble::rownames_to_column("model") %>% 
      mutate(group = i)
    
    # Plot residuals
    # res <- residuals(m1) %>% as.data.frame()
    # ggplot(res, aes(sample = V1)) + stat_qq() + stat_qq_line() + theme(aspect.ratio = 1)
    # ggsave(paste0("figures/supp/qq_density_sdm/sdm_01_", i, ".pdf"),
    #        width = 17, height = 17, units = "cm")
    
    # Save model object
    # saveRDS(m, paste("output/models/sdm_01_", i, ".rds", sep = ""))
    
    # Predict on grid
    # pred <- predict(m, newdata = pred_grid) %>% mutate(model = i)
    # 
    # data_list_pred[[i]] <- pred
  
}

# Save predictions and sims as data frames
data_aic <- dplyr::bind_rows(data_list_aic)

write_csv(data_aic, "output/data_aic_01.csv")
```

## Plot AIC

```{r}
# m1 <- sdmTMB(density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + temp_sc,
# m2 <- sdmTMB(density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + breakpt(oxy_sc),
# m3 <- sdmTMB(density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + breakpt(oxy_sc) + temp_sc,
# m4 <- sdmTMB(density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + oxy_sc*temp_sc,
# m5 <- sdmTMB(density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + breakpt(phi_sc),
# m6 <- sdmTMB(density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + breakpt(phi_c_sc),
# m7 <- sdmTMB(density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + s(phi_sc),
# m8 <- sdmTMB(density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + s(phi_c_sc),

aic <- read.csv("output/data_aic_01.csv") %>% 
  mutate(formula = ifelse(model == "m1", "temperature", NA),
         formula = ifelse(model == "m2", "bp(oxygen)", formula),
         formula = ifelse(model == "m3", "bp(oxygen) + temperature", formula),
         formula = ifelse(model == "m4", "oxygen × temperature", formula),
         # formula = ifelse(model == "m5", "bp(phi_p)", formula),
         # formula = ifelse(model == "m6", "bp(phi_c)", formula),
         formula = ifelse(model == "m7", "s(phi_p)", formula),
         formula = ifelse(model == "m8", "s(phi_c)", formula)) %>% 
  group_by(group) %>% 
  mutate(delta_aic = AIC - min(AIC),
         Favoured = ifelse(delta_aic < 2, "Y", "N")) %>% 
  ungroup() %>% 
  separate(group, into = c("species", "life_stage")) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage)) %>% 
  mutate(group2 = paste(species, life_stage))
  
ggplot(aic, aes(group2, delta_aic, color = formula, shape = Favoured)) +
  geom_point(size = 2.8, position = position_dodge(width = 0.25), alpha = 0.6) + 
  theme_plot() + 
  scale_shape_manual(values = c(21, 16)) +
  scale_color_manual(values = pal) +
  coord_flip() +
  labs(x = "", y = "\u0394 AIC", color = "Formula", alpha = "Lowest AIC") + 
  theme(legend.direction = "vertical",
        plot.margin = unit(c(0, 0, 0.3, 0), "cm")) + 
  guides(color = guide_legend(ncol = 1)) +
  theme_plot(base_size = 16) +
  theme(legend.direction = "vertical") +
  NULL

ggsave("figures/aic.pdf", width = 15, height = 15, units = "cm", device = cairo_pdf)

# As table..
aict <- aic %>% 
  dplyr::select(-Favoured) %>% 
  rename(Model = model, Formula = formula, Group = group2)

knitr::kable(aict) %>% 
  kable_styling()%>%
  row_spec(which(aic$Favoured == "Y"), bold = T, hline_after = T) %>% 
  save_kable(file = "AIC_table.png")
```

```{r}
# Fit m8 (smooth phi) models and save conditional effect of MI
data_list <- list()

i <- unique(d$group)[1]

for(i in unique(d$group)) { 
    
    dd <- d %>%
      filter(group == i) %>%
      droplevels() %>% 
      drop_na(density)
    
    mesh <- make_mesh(dd, c("X", "Y"), n_knots = 200)

    plot(mesh)
    
    m8 <- sdmTMB(
      density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + s(phi_c_sc),
      data = dd, mesh = mesh, family = tweedie(link = "log"),
      spatial = "on", time = "year", spatiotemporal = "off",
      control = sdmTMBcontrol(newton_loops = 1))

    sanity(m8)

    # Plot residuals
    res <- residuals(m8) %>% as.data.frame()
    ggplot(res, aes(sample = V1)) + stat_qq() + stat_qq_line() + theme(aspect.ratio = 1)
    ggsave(paste0("figures/supp/qq_density_sdm/sdm_01_m8_", i, ".pdf"),
           width = 17, height = 17, units = "cm")
    
    # Save model object
    saveRDS(m8, paste("output/models/sdm_01_m8_", i, ".rds", sep = ""))
    
    # Predict over Phi
    nd <- data.frame(phi_c = seq(quantile(dd$phi_c, probs = 0.1), quantile(dd$phi_c, probs = 0.9), length.out = 50)) %>% 
      mutate(phi_c_sc = (phi_c - mean(dd$phi_c)) / sd(dd$phi_c), 
             year = 2000,
             year_f = as.factor(2000), 
             quarter_f = as.factor(1), 
             depth_sc = 0,
             depth_sq = 1,
             group = i, 
             X = mean(d$X),
             Y = mean(d$Y))
    
    pred <- predict(m8, newdata = nd)
  
    data_list[[i]] <- pred

}

# Save predictions and sims as data frames
df <- dplyr::bind_rows(data_list)

write_csv(df, "output/data_conditional_01_m8.csv")
```

## Plot conditional effects of phi

```{r}
df <- read_csv("output/data_conditional_01_m8.csv")

# Scale to max est within group
df <- df %>% 
  group_by(group) %>% 
  mutate(est_sc = exp(est) / max(exp(est))) %>% 
  separate(group, into = c("species", "life_stage"), remove = FALSE) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage))

pal <- brewer.pal(name = "Dark2", n = 8)

ggplot(df, aes(phi_c, est_sc, color = species)) + 
  geom_line() + 
  facet_wrap(~factor(life_stage, levels = c("Juvenile", "Adult")), ncol = 1) +
  #scale_color_brewer(palette = "Dark2", name = "", direction = -1) +
  scale_color_manual(values = rev(pal), name = "") +
  theme(legend.position = c(0.9, 0.95),
        legend.background = element_rect(fill = NA)) + 
  labs(y = "Scaled prediction", x = "Metabolic index (\u03C6)") +
  theme_plot(base_size = 14)

ggsave("figures/conditional_phi.pdf", width = 15, height = 15, units = "cm", device = cairo_pdf)
```

```{r}
## Fit m4 models and save conditional effect of temperature given low and high temperature
data_list2 <- list()

for(i in unique(d$group)) { 
    
    dd <- d %>%
      filter(group == i) %>%
      droplevels() %>% 
      drop_na(density)
    
    mesh <- make_mesh(dd, c("X", "Y"), n_knots = 200)

    plot(mesh)
    
    m4 <- sdmTMB(
      density ~ 0 + year_f + quarter_f + depth_sc + depth_sq + oxy_sc*temp_sc,
      data = dd, mesh = mesh, family = tweedie(link = "log"),
      spatial = "on", time = "year", spatiotemporal = "off",
      control = sdmTMBcontrol(newton_loops = 1))

    sanity(m4)

    # Plot residuals
    res <- residuals(m4) %>% as.data.frame()
    ggplot(res, aes(sample = V1)) + stat_qq() + stat_qq_line() + theme(aspect.ratio = 1)
    ggsave(paste0("figures/supp/qq_density_sdm/sdm_01_m4_", i, ".pdf"),
           width = 17, height = 17, units = "cm")
    
    # Save model object
    saveRDS(m4, paste("output/models/sdm_01_m4_", i, ".rds", sep = ""))
    
    # Predict over Phi
    nd <- data.frame(expand.grid(temp = seq(quantile(dd$temp, probs = 0.1), quantile(dd$temp, probs = 0.9), length.out = 50),
                                 oxy = seq(quantile(dd$oxy, probs = 0.1), quantile(dd$oxy, probs = 0.9), length.out = 2))) %>% 
      mutate(temp_sc = (temp - mean(dd$temp)) / sd(dd$temp),
             oxy_sc = (oxy - mean(dd$oxy)) / sd(dd$oxy), 
             year = 2000,
             year_f = as.factor(2000), 
             quarter_f = as.factor(1), 
             depth_sc = 0,
             depth_sq = 1,
             group = i, 
             X = mean(d$X),
             Y = mean(d$Y))
    
    pred2 <- predict(m4, newdata = nd)
  
    data_list2[[i]] <- pred2

}

# Save predictions and sims as data frames
df2 <- dplyr::bind_rows(data_list2)

write_csv(df2, "output/data_conditional_01_m4.csv")
```

## Plot conditional effects of temperature and oxygen

```{r}
df <- read_csv("output/data_conditional_01_m4.csv")

# Scale to max est within group
df <- df %>% 
  separate(group, into = c("species", "life_stage"), remove = FALSE) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage)) %>% 
  group_by(group) %>% 
  mutate(oxy2 = ifelse(oxy == min(oxy), "Low oxygen", "High oxygen")) %>% 
  ungroup()

ggplot(df, aes(temp, exp(est), color = species, linetype = life_stage)) + 
  geom_line() + 
  facet_wrap(~ oxy2, ncol = 1) +
  scale_color_manual(values = rev(pal), name = "") +
  labs(linetype = "") +
  labs(y = "Scaled prediction", x = "Temperature (°C)")

#ggh4x::facet_grid2(. ~ cyl, scales = "free_y", independent = "y")
library(ggh4x)
ggplot(df, aes(temp, exp(est), color = oxy2)) + 
  geom_line(size = 1) + 
  facet_grid2(species ~ life_stage, scales = "free_y", independent = "y") +
  #scale_color_manual(values = rev(pal), name = "") +
  scale_color_manual(values = c("tomato3", "steelblue2"), name = "") +
  labs(linetype = "") +
  labs(y =  bquote("Biomass density"~(kg/km^2)), x = "Temperature (°C)") + 
  theme_plot(base_size = 14) +
  NULL

ggsave("figures/conditional_temp_oxy.pdf", width = 15, height = 15, units = "cm", device = cairo_pdf)
```

- knit this
- to authors: depth co-regulating, smooth better than thresh bc high phi in wird places (plot). plot also difference between phis in space, and point(color by deph?)
