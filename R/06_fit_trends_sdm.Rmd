---
title: "Fit models with metabolic index and temperature trends for each species"
author: "Max Lindmark"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
  df_print: paged
pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, cache=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 12,
  fig.asp = 0.618,
  fig.align ='center'
)
```

# Intro
Main analysis: This scripts reads spatially referenced linear trends over time in biomass, metabolic index and temperature ("05_calculate_trends.Rmd"), and fits spatial sdmTMB models to those

```{r load libraries, message=FALSE, warning=TRUE}
# Load libraries, install if needed
library(tidyverse)
library(tidylog)
library(RCurl)
library(devtools)
library(sdmTMB)
library(rMR)
library(patchwork)
library(raster)
library(VoCC)
library(RColorBrewer)
library(viridis)
library(ggh4x)
library(ggridges)

# Source code for plots
source_url("https://raw.githubusercontent.com/maxlindmark/spatial-metabolic-index/main/R/functions/map-plot.R")

theme_set(theme_plot())

pal <- brewer.pal(name = "Dark2", n = 8)
```

## Read and plot data

```{r}
# Read from GH?
d <- read_csv("data/clean/trends.csv")

glimpse(d)

plot_map + 
  geom_raster(data = d, aes(X*1000, Y*1000, fill = biom_slope)) +
  facet_grid(life_stage ~ species) + 
  #scale_fill_gradient2() +
  scale_fill_viridis()

plot_map + 
  geom_raster(data = d, aes(X*1000, Y*1000, fill = temp_slope)) +
  facet_grid(life_stage ~ species) + 
  scale_fill_viridis()

plot_map + 
  geom_raster(data = d, aes(X*1000, Y*1000, fill = phi_slope)) +
  facet_grid(life_stage ~ species) + 
  scale_fill_viridis()

d_cod <- filter(d, species == "cod" & life_stage == "adult")

p1 <- plot_map + 
  geom_raster(data = d_cod, aes(X*1000, Y*1000, fill = biom_slope)) + 
  scale_fill_gradient2(name = "Biotic trend") + 
  geom_sf(size = 0.3)

p2 <- plot_map + 
  geom_raster(data = d_cod, aes(X*1000, Y*1000, fill = temp_slope)) + 
  scale_fill_gradient2(name = "Temperature trend", breaks = c(0.025, 0.075, 0.125)) + 
  geom_sf(size = 0.3)

p3 <- plot_map + 
  geom_raster(data = d_cod, aes(X*1000, Y*1000, fill = phi_slope)) + 
  scale_fill_gradient2(name = "\u03C6 trend") + 
  geom_sf(size = 0.3)

((p2 + p3) / (p1 + plot_spacer()))
ggsave("figures/map_trends_cod.pdf", width = 17, height = 17, units = "cm", device = cairo_pdf)

# Scale biomass trends (temperature, phi)
d <- d %>% 
  mutate(group = paste(species, life_stage, sep = "_")) %>% 
  group_by(group) %>% 
  mutate(temp_slope_sc = (temp_slope - mean(temp_slope)) / sd(temp_slope),
         phi_slope_sc = (phi_slope - mean(phi_slope)) / sd(phi_slope)) %>% 
  ungroup() %>% 
  mutate(quarter_f = as.factor(quarter))
```

## Fit sdmTMB models of biomass trends as a function of phi trends

```{r}
# Make a for loop here..
coefs <- list()
pred_trend1 <- list()
pred_trend2 <- list()

for(i in unique(d$group)){
  
  dd <- filter(d, group == i)
  
  mesh <- make_mesh(dd, c("X", "Y"), n_knots = 200)
  plot(mesh)
  
  m <- sdmTMB(
    biom_slope ~ phi_slope_sc * mean_phi_ct + mean_log_biomass_ct + quarter_f,
    mesh = mesh,
    data = dd,
    family = gaussian(), 
    spatial = "on",
    spatiotemporal = "off",
    control = sdmTMBcontrol(newton_loops = 1)
  )
  
  sanity(m) 
  
  # Save coefficients??
  coefs[[i]] <- tidy(m, conf.int = TRUE) %>% mutate(group = i)
  
  # Now predict the biotic trend for high and low temperature with a sd change in the climate trend
  low_mean_clim <- as.numeric(quantile(dd$mean_phi_ct, prob = 0.05))
  high_mean_clim <- as.numeric(quantile(dd$mean_phi_ct, prob = 0.95))
  mean_log_biomass_ct <- mean(dd$mean_log_biomass_ct)
  
  # Predict
  nd <- data.frame(phi_slope_sc = c(-1, 0, -1, 0),
                   mean_phi_ct = rep(c(low_mean_clim, high_mean_clim), each = 2),
                   mean_log_biomass_ct = rep(mean_log_biomass_ct, 4),
                   X = mean(dd$X),
                   Y = mean(dd$Y),
                   quarter_f = as.factor(4))
  
  nsim = 1000
  pred <- predict(m, newdata = nd, se_fit = TRUE, nsim = nsim)
  
  pred <- data.frame(
    mean_phi_ct = rep(c(low_mean_clim, high_mean_clim), each = nsim),
    est_change = c(pred[1, ], pred[3, ]),
    est_0 = c(pred[2, ], pred[4, ]))
  
  pred <- pred %>% 
    mutate(bio_trend_delta = est_change - est_0, # if bio trend is positive, bio increases with declines in phi
           mean_clim = ifelse(mean_phi_ct == low_mean_clim, 
                              "low_phi", "high_phi"),
           group = i)
    
  pred_trend1[[i]] <- pred
  
  # Now make a prediction across a range of trends
  # Again I'm predicting for the range of the specific model
  nd3 <- data.frame(expand.grid(phi_slope_sc = seq(quantile(dd$phi_slope_sc, probs = 0.05),
                                                   quantile(dd$phi_slope_sc, probs = 0.95),
                                                   length.out = 50),
                                mean_phi_ct = c(low_mean_clim, high_mean_clim))) %>% 
    mutate(mean_log_biomass_ct = mean_log_biomass_ct,
           X = mean(dd$X),
           Y = mean(dd$Y),
           quarter_f = as.factor(4))
  
  pred3 <- predict(m, newdata = nd3, se_fit = TRUE)
  
  pred3 <- pred3 %>% 
    mutate(lwr = est - 1.96*est_se,
           upr = est + 1.96*est_se, 
           group = i)
  
  pred_trend2[[i]] <- pred3

  }

phi_coefs <- dplyr::bind_rows(coefs) %>% 
  mutate(sig = "N",
         sig = ifelse(estimate < 0 & conf.high < 0, "Y", sig),
         sig = ifelse(estimate > 0 & conf.low > 0, "Y", sig))

phi_pred_delta <- dplyr::bind_rows(pred_trend1) %>% 
  separate(group, c("species", "life_stage"),
           sep = "_", remove = FALSE) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage))

phi_pred <- dplyr::bind_rows(pred_trend2) %>% 
  separate(group, c("species", "life_stage"),
           sep = "_", remove = FALSE) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage))

write_csv(phi_coefs, "output/phi_trend_coefs.csv")
write_csv(phi_pred_delta, "output/pred_phi_trend_delta.csv")
write_csv(phi_pred, "output/pred_phi_trend.csv")
```

## Plot phi trend models

```{r}
# Plot coefficients
phi_coefs %>% 
  filter(term %in% c("phi_slope_sc", "phi_slope_sc:mean_phi_ct")) %>% 
  ggplot(aes(estimate, group)) + 
  geom_point() + 
  geom_vline(xintercept = 0, linetype = 2, color = "grey30") + 
  facet_wrap(~term, ncol = 1)

phi_pred_delta2 <- phi_pred_delta %>%
  # pivot_wider(names_from = mean_clim, values_from = bio_trend_delta) %>%
  # mutate(diff = high_phi - low_phi) %>%
  # mutate(Expected = ifelse(diff < 0, "No", "Yes")) %>%
  # We expect in general the biotic trends to be negative
  # We also expect biotic trends to be MORE negative if it's already in a low phi area
  #pivot_longer(c(low_phi, high_phi), names_to = "mean_clim", values_to = "bio_trend_delta") %>%
  mutate(mean_clim = ifelse(mean_clim == "high_phi", "High \u03C6", "Low \u03C6")) %>%
  mutate(id2 = paste(species, life_stage))
  
order <- phi_pred_delta2 %>%
  group_by(id2, mean_clim) %>% 
  summarise(mean_delta = mean(bio_trend_delta)) %>% 
  pivot_wider(names_from = mean_clim, values_from = mean_delta) %>% 
  mutate(diff = `Low φ` - `High φ`) %>% 
  arrange(desc(diff)) %>% 
  mutate(Expected = ifelse(`Low φ` < `High φ`, "Yes", "No"))

order

phi_pred_delta2 <- phi_pred_delta2 %>% 
  left_join(order %>% dplyr::select(Expected), by = "id2")

# phi_pred_delta2 %>%
#   ggplot(aes(bio_trend_delta, fct_reorder(id2, diff), color = mean_clim, alpha = Expected)) +
#   geom_vline(xintercept = 0, linetype = 2, color = "grey30") + 
#   geom_point(size = 3, position = position_dodge(width = 0.1)) +
#   scale_color_manual(values = c("steelblue2", "tomato3")) +
#   scale_alpha_manual(values = c(0.4, 1)) +
#   labs(y = "", x = "\u0394 biotic trend with a 1 st.dev\ndecline in \u03C6 trend", color = "Mean climate") +
#   theme_plot(base_size = 16) +
#   theme(legend.direction = "vertical") +
#   NULL

phi_pred_delta2$id2 <- factor(phi_pred_delta2$id2, levels = c(order$id2))
                                 
phi_pred_delta2 %>%
  ggplot(aes(bio_trend_delta, id2, fill = mean_clim, alpha = Expected)) +
  geom_vline(xintercept = 0, linetype = 2, color = "grey30") + 
  geom_density_ridges(color = NA) +
  scale_fill_manual(values = c("steelblue2", "tomato3")) +
  scale_alpha_manual(values = c(0.4, 0.8)) +
  labs(y = "", x = "\u0394 biotic trend with a 1 st.dev\ndecline in \u03C6 trend", fill = "Mean climate") +
  theme_plot(base_size = 16) +
  theme(legend.direction = "vertical") +
  NULL

ggsave("figures/mi_trend_delta.pdf", width = 17, height = 17, units = "cm", device = cairo_pdf)
```

## Fit sdmTMB models of biomass trends as a function of temperature trends, given mean temperature

```{r}
# Make a for loop here..
pred_trend_temp <- list()
pred_trend_temp_og <- list()

for(i in unique(d$group)){
  
  dd <- filter(d, group == i)
  
  mesh <- make_mesh(dd, c("X", "Y"), n_knots = 200)
  plot(mesh)
  
  m <- sdmTMB(
    biom_slope ~ temp_slope_sc * mean_temp_ct + mean_log_biomass_ct + quarter_f,
    mesh = mesh,
    data = dd,
    family = gaussian(), 
    spatial = "on",
    spatiotemporal = "off",
    control = sdmTMBcontrol(newton_loops = 1)
  )
  
  sanity(m) 
  
  # Predict
  low_mean_clim <- as.numeric(quantile(dd$mean_temp_ct, prob = 0.05))
  high_mean_clim <- as.numeric(quantile(dd$mean_temp_ct, prob = 0.95))
  mean_log_biomass_ct <- mean(dd$mean_log_biomass_ct)
  
  nd <- data.frame(expand.grid(temp_slope_sc = c(0, 1),
                               mean_temp_ct = seq(low_mean_clim,
                                                  high_mean_clim,
                                                  length.out = 2))) %>%
    mutate(mean_log_biomass_ct = mean_log_biomass_ct,
           X = mean(dd$X),
           Y = mean(dd$Y),
           quarter_f = as.factor(4))
  
  nsim <- 1000
  pred_og <- predict(m, newdata = nd)
  pred <- predict(m, newdata = nd, nsim = nsim)
  
  pred_og <- pred_og %>%
    dplyr::select(temp_slope_sc, mean_temp_ct, est) %>%
    pivot_wider(names_from = temp_slope_sc, values_from = est) %>%
    mutate(delta_bio_trend = `1` - `0`) %>%
    mutate(group = i)
  
  pred <- data.frame(
    mean_temp_ct = rep(c(low_mean_clim, high_mean_clim), each = nsim),
    est_0 = c(pred[1, ], pred[3, ]),
    est_change = c(pred[2, ], pred[4, ])) # note different order here than phi
  
  pred <- pred %>% 
    mutate(bio_trend_delta = est_change - est_0, # if bio trend is positive, bio increases with warming
           mean_clim = ifelse(mean_temp_ct == low_mean_clim, 
                              "low_temperature", "high_temperature"),
           group = i)
  
  pred_trend_temp[[i]] <- pred
  pred_trend_temp_og[[i]] <- pred_og
  
}

pred_trend_temp <- dplyr::bind_rows(pred_trend_temp) %>% 
  separate(group, c("species", "life_stage"),
           sep = "_", remove = FALSE) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage))

pred_trend_temp_og <- dplyr::bind_rows(pred_trend_temp_og) %>% 
  separate(group, c("species", "life_stage"),
           sep = "_", remove = FALSE) %>% 
  mutate(species = str_to_title(species),
         life_stage = str_to_title(life_stage))

write_csv(pred_trend_temp, "output/pred_temp_trend.csv")
```

```{r}
pred_trend_temp_og %>%
  group_by(group) %>%
  mutate(mean_clim = ifelse(mean_temp_ct == min(mean_temp_ct), "Cold", "Warm")) %>%
  ungroup() %>%
  dplyr::select(mean_clim, group, species, life_stage, delta_bio_trend) %>%
  pivot_wider(names_from = mean_clim, values_from = delta_bio_trend) %>%
  mutate(diff = Cold-Warm) %>%
  mutate(Expected = ifelse(diff > 0, "Yes", "No")) %>%
  pivot_longer(c(Cold, Warm), names_to = "mean_clim", values_to = "delta_bio_trend") %>%
  mutate(id2 = paste(species, life_stage)) %>%
  ggplot(aes(delta_bio_trend, fct_reorder(id2, diff), color = mean_clim, alpha = Expected)) +
  geom_point(size = 3, position = position_dodge(width = 0.1)) +
  scale_color_manual(values = c("steelblue2", "tomato3")) +
  scale_alpha_manual(values = c(0.4, 0.8)) +
  geom_vline(xintercept = 0, linetype = 2, color = "grey30") +
  labs(y = "", x = "\u0394 biotic trend with a 1 st.dev\nincrease in temperature trend", color = "Mean temperature") +
  theme_plot(base_size = 16) +
  theme(legend.direction = "vertical") +
  NULL

temp_pred_delta2 <- pred_trend_temp %>%
  mutate(mean_clim = ifelse(mean_clim == "low_temperature", "Cold", "Warm")) %>%
  mutate(id2 = paste(species, life_stage))
  
order <- temp_pred_delta2 %>%
  group_by(id2, mean_clim) %>% 
  summarise(mean_delta = mean(bio_trend_delta)) %>% 
  pivot_wider(names_from = mean_clim, values_from = mean_delta) %>% 
  mutate(diff = `Warm` - `Cold`) %>% 
  arrange(desc(diff)) %>% 
  mutate(Expected = ifelse(Cold > Warm, "Yes", "No"))

order

temp_pred_delta2 <- temp_pred_delta2 %>% 
  left_join(order %>% dplyr::select(Expected), by = "id2")

temp_pred_delta2$id2 <- factor(temp_pred_delta2$id2, levels = c(order$id2))
                                 
temp_pred_delta2 %>%
  ggplot(aes(bio_trend_delta, id2, fill = mean_clim, alpha = Expected)) +
  geom_vline(xintercept = 0, linetype = 2, color = "grey30") + 
  geom_density_ridges(color = NA) +
  scale_fill_manual(values = c("steelblue2", "tomato3")) +
  scale_alpha_manual(values = c(0.4, 1)) +
  labs(y = "", x = "\u0394 biotic trend with a 1 st.dev\nincrease in temperature trend", fill = "Mean temperature") +
  theme_plot(base_size = 16) +
  theme(legend.direction = "vertical") +
  NULL

ggsave("figures/temp_trend_delta.pdf", width = 15, height = 17, units = "cm", device = cairo_pdf)
```
